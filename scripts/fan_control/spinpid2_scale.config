#!/bin/bash

# Config file for spinpid2_scale.sh - TrueNAS SCALE version
# Based on original spinpid2.sh (2020-08-20) by Kevin Horton
# Adapted for TrueNAS SCALE with IPMI over LAN

#################  IPMI SETTINGS ################

# IPMI connection settings for TrueNAS SCALE
# Uses lanplus interface to connect to BMC over network
IPMI_HOST="192.168.1.235"
IPMI_USER="dafydd"
IPMI_PASS="5m3gh3ad!"

# Full ipmitool command with connection parameters
IPMITOOL="ipmitool -I lanplus -H ${IPMI_HOST} -U ${IPMI_USER} -P ${IPMI_PASS}"

#################  OUTPUT SETTINGS ################

# Log location - stored on persistent storage
LOG_DIR="/mnt/RaidZ3/local_TrueNAS_scripts/fan_control"
LOG="${LOG_DIR}/spinpid2_scale.log"

# Where do you want output to go?
# First sends output to the log file AND to screen/console, good for testing.
# Second goes only to log file, no feedback if running manually.
# exec > >(tee -i "$LOG") 2>&1		# Log + console, good for testing
# exec &> $LOG						# Log only

# CPU output is sent to a separate log for interim cycles
# It can get big so turn off after testing. 1 = log cpu; anything else = don't log cpu
CPU_LOG_YES=0

# Path/name of cpu log
CPU_LOG="${LOG_DIR}/spinpid2_scale-cpu.log"

#################  FAN SETTINGS ################

# Supermicro says:
# Zone 0 - CPU/System fans, headers with number (e.g., FAN1, FAN2, etc.)
# Zone 1 - Peripheral fans, headers with letter (e.g., FANA, FANB, etc.)
# Some want the reverse (i.e, drive cooling fans on headers FAN1-4 and 
# CPU fan on FANA), so that's the default. But you can switch to SM way.
ZONE_CPU=1
ZONE_PER=0

# Set min and max duty cycle to avoid stalling or zombie apocalypse
DUTY_PER_MIN=55
DUTY_PER_MAX=100
DUTY_CPU_MIN=65
DUTY_CPU_MAX=100

# Using spintest.sh, measure fan RPMs at 30% duty cycle and 100% duty cycle.
# RPM_CPU is for FANA if ZONE_CPU=1 or FAN1 if ZONE_CPU=0
# RPM_PER is for the other fan.
RPM_CPU_30=300
RPM_CPU_MAX=1700
RPM_PER_30=300
RPM_PER_MAX=1600

# How should we determine what the fan duty (% of full power) is?
# (1) let the script read it from the board
# (0) assume it's where it was set last time
# Some dual-zone boards report incorrect fan duty, use 0 for those
HOW_DUTY=0

#################  DRIVE SETTINGS ################

# Setpoint mean drive temperature (C)
SP=40

# Time interval for checking drives (minutes).
# Drives change temperature slowly; 5 minutes is probably frequent enough.
DRIVE_T=1

# Tunable constants for drive PID control
Kp=4    # Proportional tunable constant
Kd=40   # Derivative tunable constant

#################  CPU SETTINGS ################

# Time interval for checking CPU (seconds). 1 to 12 may be appropriate
CPU_T=1

# Reference temperature (C) for scaling CPU_DUTY (NOT a setpoint).
# At and below this temperature, CPU will demand minimum duty cycle (DUTY_CPU_MIN).
CPU_REF=50  # Integer only!

# Scalar for scaling CPU_DUTY.
# CPU will demand this number of percentage points in additional
# duty cycle for each degree of temperature above CPU_REF.
CPU_SCALE=6  # Integer only!

#################  OPTIONAL ################

# If you wish to implement user-defined actions after Drives_check_adjust() 
# and CPU_check_adjust(), you can define Post_DRIVES_check_adjust() 
# and Post_CPU_check_adjust() here.
